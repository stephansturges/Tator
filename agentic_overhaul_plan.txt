AGENTIC OVERHAUL PLAN (DEEP PREPASS + TARGETED VLM REVIEW)
===========================================================

Status: NEW SPEC (replaces all prior agentic flows)
Owner: engineering
Location: /home/steph/Tator/agentic_overhaul_plan.txt

OVERVIEW
--------
This plan fully replaces the current agentic annotation workflow. The new system
leans on a stronger, deterministic "deep prepass" and uses VLMs only for targeted,
grid-wise quality review. No open-ended agent tool loops. No coordinate reasoning.

Key ideas:
- Deep prepass finds and validates most objects deterministically.
- VLMs act as reviewers, not detectors.
- Review is per-tile, per-class, using raw + overlay images.
- Output is a structured "Agent Annotation Quality Review Grid" used for triage.
- A final reviewer agent summarizes which tiles need manual attention (no edits).

GOALS
-----
- Improve recall/precision by enhancing prepass (not by agent rambling).
- Keep VLM workload small, deterministic, and interpretable.
- Track detection provenance (which detector/prompt/exemplar produced each handle).
- Provide explicit, structured review results for human or future automation.

NON-GOALS
---------
- No tool-calling loops during review.
- No VLM-led detection or free-form exploration.
- No coordinate or token internal IDs exposed to VLMs.
- No truncation of detections in deep prepass or review.

SECTION 1: DEEP PREPASS (DETERMINISTIC)
---------------------------------------
1.1 Pipeline
  1) Detector pass: YOLO + RF-DETR (both with SAHI).
  2) SAM3 text prompts: LLM-expanded synonyms from glossary, run over full image.
  3) Dedupe + cluster + classifier cleanup (pass A).
  4) SAM3 similarity pass (new):
     - Choose exemplar handles per class:
       - High-confidence (verified or score >= 0.60).
       - Mid-confidence "unusual items" (score in [0.45, 0.60] with low class frequency).
     - Run similarity across grid windows (or SAHI windows), not full-image only.
     - Use the class of the exemplar as the label for all returned detections.
  5) Dedupe + cluster + classifier cleanup (pass B).
  6) Finalize deep prepass clusters with provenance metadata.

1.2 Cluster Provenance (required)
Store per cluster:
  - handle (e.g., LV12)
  - label
  - score
  - sources: ["yolo", "rfdetr", "sam3_text", "sam3_similarity"]
  - source_primary (highest-confidence source)
  - source_prompt (if sam3_text: exact prompt, e.g., "sedan")
  - source_exemplar_handles (if sam3_similarity: list of exemplars)
  - source_detector_run_id (if detector, optional)
  - classifier_best, classifier_prob, classifier_accept

1.3 No Caps
  - No max_detections caps in prepass tools.
  - No max_objects caps in inspect-style tools (if used internally).
  - If memory is a concern, constrain by confidence thresholds only.

SECTION 2: OVERLAY + GRID
-------------------------
2.1 Grid
  - Grid size is parameterized (UI + API).
  - Grid has overlap (default 20%); overlap is hidden from VLMs.
  - Grid labeling: columns A.., rows 1..n.

2.2 Overlay
  - One overlay image per tile + full image.
  - Each detection shows:
    - colored dot (class color)
    - handle text (class prefix + id, e.g., LV12)
  - Legend: class name -> color -> handle prefix.

SECTION 3: REVIEW AGENTS (VLM, NO TOOL LOOPS)
---------------------------------------------
These are not "agents with tools". Each is a deterministic VLM call over:
  - raw tile image
  - overlay tile image
  - short structured prompt
Output is strict JSON. No free text. No follow-ups.

3.1 Completeness Agent (per tile, per class)
Goal: "Are ALL items of class X annotated in this tile?"
Input:
  - tile raw image
  - tile overlay image
  - class name + glossary summary
Prompt pattern:
  - Explain handle format and color for that class.
  - Ask YES/NO if all items are annotated.
Output:
  {"tile":"C2","label":"light_vehicle","complete":true|false}

3.2 Confidence Agent (per tile, per class)
Goal: "Are any handles for class X likely false positives?"
Input:
  - tile raw image
  - tile overlay image
  - class name + handle prefix
Output:
  {"tile":"C2","label":"light_vehicle","false_positive_handles":["LV12","LV33"]}

SECTION 4: REVIEW GRID STORE
----------------------------
Define "Agent Annotation Quality Review Grid" (AAQRG):
  - per tile, per class
  - fields:
    - complete (bool)
    - false_positive_handles (list)
    - timestamp
    - model_id / variant
    - grid_size
  - stored in memory and serialized to trace logs

SECTION 5: GLOBAL REVIEWER (VLM SUMMARY ONLY)
---------------------------------------------
Input:
  - AAQRG summary
  - counts per tile / class
  - overall caption + windowed captions
  - full overlay image
Output:
  {"tiles_needing_manual_review":["B2","E4"],"notes":"..."}

No changes are applied. This is purely a triage summary.

SECTION 6: REMOVALS / DELETIONS
-------------------------------
- Remove current multi-agent tile loop + tool-calling sessions.
- Remove LLM tool-facade prompt recipes for TileScout/Detector/Verifier/etc.
- Remove controller retry logic and tool gating logic used by those agents.
- Keep prepass tools and overlay rendering (they are still used).
- The /qwen/agentic endpoint should route to the new deep-prepass + VLM review flow.

SECTION 7: TRACE + LOGGING
--------------------------
- Maintain readable logs for each step:
  - deep prepass stages
  - similarity pass per class
  - dedupe + classifier cleanup
  - review agents per tile/class
  - final reviewer output
- Use ASCII separators per image and per stage.

SECTION 8: DETERMINISTIC CONFIG
-------------------------------
Defaults:
  - deterministic decode: temperature=0, top_p=1
  - fixed grid size default (UI-controlled)
  - exemplar threshold >= 0.60 for similarity
  - mid-confidence range: 0.45..0.60 (if class count low)
  - classifier thresholds: as current default

SECTION 8.1: PARAMETERIZATION (API + UI)
----------------------------------------
All items below must be exposed in the web UI and carried through the API:
- Grid
  - grid_cols, grid_rows (or unified grid_size)
  - grid_overlap_ratio (default 0.20)
  - overlay_dot_radius
- Prepass (detectors)
  - enable_yolo (bool)
  - enable_rfdetr (bool)
  - yolo_id, rfdetr_id (or run ids)
  - sahi_window_size, sahi_overlap_ratio
  - detector_conf
- Prepass (SAM3 text)
  - enable_sam3_text
  - sam3_text_score_thr, sam3_text_mask_thr
  - sam3_text_synonym_budget (max prompts per class)
- Similarity expansion (new)
  - enable_sam3_similarity
  - similarity_min_exemplar_score (default 0.60)
  - similarity_mid_conf_range (low, high)
  - similarity_mid_conf_class_count (trigger threshold)
  - similarity_window_mode ("grid" or "sahi")
  - similarity_window_stride / overlap (if SAHI mode)
- Classifier cleanup
  - classifier_id (single default)
  - classifier_min_prob, classifier_margin, classifier_bg_margin
- Review agents
  - review_model_id + review_variant
  - review_max_tokens
  - review_enabled (global on/off)
  - review_classes (optional subset; default labelmap)
  - review_passes_per_tile (default 1)

SECTION 9: TOOLING
------------------
No tool-calling agents in review.
Prepass tools remain:
  - run_detector (YOLO, RF-DETR, SAHI)
  - sam3_text
  - sam3_similarity
  - classify_crop
Overlay + review utilities remain:
  - render overlay images
  - grid helpers

SECTION 10: 10-COMMIT IMPLEMENTATION PLAN
-----------------------------------------
Commit 1: Spec + shared config scaffolding
  - Replace old brief with this spec.
  - Add DeepPrepassConfig + ReviewConfig structs in API layer.
  - Plumb UI fields into agentic payload (grid, prepass, similarity, review).
  - Add trace fields for deep_prepass_version and review_version.

Commit 2: Deep prepass part A (detectors + SAM3 text)
  - Run YOLO + RF-DETR with SAHI using UI-configured window size/overlap.
  - Run SAM3 text synonyms (LLM-expanded from glossary) with per-class prompt budget.
  - Store provenance per detection (source + prompt used for SAM3 text).
  - Add readable log lines for each step and source counts.

Commit 3: Dedupe + classifier cleanup (pass A)
  - Run IOU-based clustering on combined detections.
  - Apply classifier filtering using UI-configured thresholds.
  - Persist cluster provenance (sources, primary source, prompt, scores).

Commit 4: Similarity expansion selection
  - Select exemplars per class:
    - High-confidence (verified or score >= similarity_min_exemplar_score).
    - Mid-confidence (score in similarity_mid_conf_range AND class count < threshold).
  - Ensure exemplar handles are recorded in provenance.

Commit 5: Similarity expansion execution
  - Run SAM3 similarity on selected exemplars.
  - Support window mode: grid or SAHI (UI param).
  - Register detections with correct class + exemplar provenance.

Commit 6: Dedupe + classifier cleanup (pass B)
  - Re-run clustering after similarity expansion.
  - Re-apply classifier filtering deterministically.
  - Update cluster provenance with source_primary selection rules.

Commit 7: Overlay + grid parameterization
  - Render full + tile overlays using UI-configured grid size and overlap.
  - Add class color + handle prefix legend to overlays.
  - Ensure overlay dot radius is UI-controlled.

Commit 8: Completeness agent (review pass A)
  - Implement per-tile, per-class completeness check:
    - Input: raw tile + overlay tile + class glossary snippet.
    - Output: strict JSON {tile,label,complete}.
  - Store results in AAQRG with model_id/variant/grid_size.

Commit 9: Confidence agent (review pass B)
  - Implement per-tile, per-class false-positive check:
    - Input: raw tile + overlay tile + class handle prefix.
    - Output: strict JSON {tile,label,false_positive_handles[]}.
  - Store results in AAQRG; include timestamps + model metadata.

Commit 10: Global reviewer + legacy removal
  - Summarize AAQRG + captions + overlay with a final reviewer prompt.
  - Output only tiles needing manual review.
  - Remove all legacy tool-calling agent loops and route /qwen/agentic to:
    deep_prepass -> overlays -> AAQRG review -> global review summary.
  - Update smoke/benchmark scripts to compare:
    yolo, deep_prepass, deep_prepass+review.

OPEN TOPICS (TRACK DURING IMPLEMENTATION)
-----------------------------------------
- Confirm SAHI window size and stride per detector for deep prepass.
- Decide how to store provenance for blended sources (score tie-break rules).
- Determine class-prefix collision rules (unique per label).
- Performance profiling for similarity pass (cost control).
